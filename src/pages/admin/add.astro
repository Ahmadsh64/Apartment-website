---
const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
const SUPABASE_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;
const VERCEL_HOOK = import.meta.env.VITE_VERCEL_DEPLOY_HOOK || '';
const BUCKET = 'properties';
const FILE = 'properties.json';
---

<html lang="he">
  <head>
    <meta charset="utf-8" />
    <title>הוספת דירה - Admin</title>
  </head>
  <body>
    <h1>הוספת דירה (Admin)</h1>
    <form id="propForm">
      <label>כותרת: <input name="title" required /></label><br/>
      <label>מחיר: <input name="price" type="number" required /></label><br/>
      <label>כתובת: <input name="address" required /></label><br/>
      <label>תמונה (URL): <input name="image" required /></label><br/>
      <label>תיאור: <textarea name="description"></textarea></label><br/>
      <button type="submit">הוסף</button>
    </form>

    <script type="module">
      import { createClient } from 'https://esm.sh/@supabase/supabase-js';

      // הזרקה מה-frontmatter (כמחרוזות)
      const SUPABASE_URL = `${Astro.props.SUPABASE_URL ?? ""}`;
      const SUPABASE_KEY = `${Astro.props.SUPABASE_KEY ?? ""}`;

      const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

      document.getElementById('propForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const newProp = {
          id: Date.now(),
          title: fd.get('title'),
          price: Number(fd.get('price')),
          address: fd.get('address'),
          image: fd.get('image'),
          description: fd.get('description')
        };

        // קבל session (access token)
        const { data: { session } } = await supabase.auth.getSession();
        const token = session?.access_token;
        if (!token) {
          alert('יש להתחבר');
          location.href = '/auth/login';
          return;
        }

        const res = await fetch('/api/update-and-deploy', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ action: 'add', property: newProp })
        });

        const result = await res.json();
        if (!res.ok) return alert('שגיאה: ' + (result.error || 'unknown'));
        alert('דירה נוספה בהצלחה');
        location.href = '/';
      });
    </script>
  </body>
</html>
